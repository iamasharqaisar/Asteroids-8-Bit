<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>8-Bit Asteroids</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --neon-green: #39ff14;
            --crt-bg: #0d1117;
            --ui-bg: rgba(0, 20, 0, 0.9);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: var(--neon-green);
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
        }

        canvas {
            background-color: #000;
            display: block;
            image-rendering: pixelated;
        }

        /* CRT Scanline Effect Overlay */
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        .screen-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
            pointer-events: none;
            z-index: 11;
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            text-shadow: 2px 2px 0px #000;
            pointer-events: none;
        }

        #score-display { font-size: 16px; margin-bottom: 10px; }
        #lives-display { font-size: 16px; }

        /* Settings Button & Menu */
        #settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 40;
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        #settings-btn:hover {
            background: var(--neon-green);
            color: black;
        }

        #settings-modal {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 250px;
            background: var(--ui-bg);
            border: 2px solid var(--neon-green);
            padding: 15px;
            z-index: 40;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }

        #settings-modal.show {
            display: flex;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
        }

        /* Retro Checkbox */
        .toggle-switch {
            appearance: none;
            width: 40px;
            height: 20px;
            border: 2px solid var(--neon-green);
            background: transparent;
            position: relative;
            cursor: pointer;
            outline: none;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background: var(--neon-green);
            transition: left 0.1s;
        }

        .toggle-switch:checked::after {
            left: 22px;
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 30;
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border: 4px solid var(--neon-green);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            font-size: 32px;
            margin: 0;
            text-transform: uppercase;
            text-shadow: 4px 4px 0px #004400;
        }

        p {
            font-size: 12px;
            line-height: 1.6;
        }

        button.retro-btn {
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Press Start 2P', cursive;
            padding: 15px 20px;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.1s;
        }

        button.retro-btn:hover {
            background: var(--neon-green);
            color: #000;
        }

        button.retro-btn:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        /* Touch Controls */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 160px;
            z-index: 25;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .touch-btn {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(57, 255, 20, 0.5);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(57, 255, 20, 0.8);
            font-size: 24px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .touch-btn:active, .touch-btn.active {
            background: rgba(57, 255, 20, 0.3);
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            h1 { font-size: 24px; }
            #start-screen { padding: 20px; width: 80%; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="scanlines"></div>
        <div class="screen-glow"></div>
        
        <canvas id="gameCanvas"></canvas>

        <!-- UI Layers -->
        <div id="ui-layer">
            <div id="score-display">SCORE: 0</div>
            <div id="lives-display">LIVES: 3</div>
        </div>

        <!-- Settings -->
        <button id="settings-btn">⚙</button>
        <div id="settings-modal">
            <div class="setting-row">
                <span>MUSIC</span>
                <input type="checkbox" id="music-toggle" class="toggle-switch" checked>
            </div>
            <div class="setting-row">
                <span>TOUCH CTRL</span>
                <input type="checkbox" id="touch-toggle" class="toggle-switch" checked>
            </div>
        </div>

        <!-- Screens -->
        <div id="start-screen">
            <h1>Asteroid<br>8-Bit</h1>
            <p>Destory squares.<br>Don't die.</p>
            <p style="color: #aaa; font-size: 10px;">ARROWS/WASD + SPACE<br>TOUCH TO PLAY</p>
            <button class="retro-btn" id="start-btn">INSERT COIN (START)</button>
        </div>

        <div id="game-over-screen" class="hidden">
            <h1>GAME OVER</h1>
            <p id="final-score">SCORE: 0</p>
            <button class="retro-btn" id="restart-btn">TRY AGAIN</button>
        </div>

        <div id="mobile-controls">
            <div class="control-group">
                <div class="touch-btn" id="btn-left">◀</div>
                <div class="touch-btn" id="btn-right">▶</div>
            </div>
            <div class="control-group">
                <div class="touch-btn" id="btn-shoot">●</div>
                <div class="touch-btn" id="btn-thrust">▲</div>
            </div>
        </div>
    </div>

<script>
/**
 * 8-BIT ASTEROIDS
 * Audio Synthesis, Settings & Game Logic
 */

// --- Audio System (Web Audio API) ---
const AudioSys = (() => {
    let ctx = null;
    let masterGain = null;
    let musicInterval = null;
    let musicIndex = 0;
    let musicMuted = false;

    // Simple looping bassline pattern (frequencies in Hz)
    const bassLine = [
        110, 0, 110, 0, // A2
        130.81, 0, 130.81, 0, // C3
        146.83, 0, 146.83, 0, // D3
        164.81, 0, 164.81, 0  // E3
    ];

    function init() {
        if (!ctx) {
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = ctx.createGain();
            masterGain.gain.value = 0.5; // Boosted Master Volume
            masterGain.connect(ctx.destination);
        }
        if (ctx.state === 'suspended') {
            ctx.resume();
        }
    }

    // Helper to ensure audio is running on any interaction
    function checkResume() {
        if (ctx && ctx.state === 'suspended') {
            ctx.resume();
        }
    }

    function toggleMusic(mute) {
        musicMuted = mute;
        if (musicMuted) {
            clearInterval(musicInterval);
            musicInterval = null;
        } else if (gameRunning) {
            startMusic();
        }
    }

    function startMusic() {
        if (musicInterval) clearInterval(musicInterval);
        if (musicMuted) return;

        musicIndex = 0;
        // 120 BPM approx (125ms per 16th note step, we play 8th notes here)
        musicInterval = setInterval(() => {
            if (!gameRunning) return;
            
            const freq = bassLine[musicIndex % bassLine.length];
            if (freq > 0) {
                // Increased volume from 0.1 to 0.4
                playTone(freq, 'triangle', 0.1, 0.4); 
            }
            musicIndex++;
        }, 200); 
    }

    function stopMusic() {
        clearInterval(musicInterval);
        musicInterval = null;
    }

    function playTone(freq, type, duration, vol = 1) {
        // Removed suspended check - try to play anyway and attempt resume
        if (!ctx) return;
        if (ctx.state === 'suspended') ctx.resume();

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        
        gain.gain.setValueAtTime(vol * 0.5, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

        osc.connect(gain);
        gain.connect(masterGain);
        
        osc.start();
        osc.stop(ctx.currentTime + duration);
    }

    function shoot() {
        if (!ctx) return;
        if (ctx.state === 'suspended') ctx.resume();

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(800, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(300, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        
        osc.connect(gain);
        gain.connect(masterGain);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
    }

    function thrust() {
        if (!ctx) return;
        if (ctx.state === 'suspended') ctx.resume();

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(50, ctx.currentTime);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);

        osc.connect(gain);
        gain.connect(masterGain);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
    }

    function explode() {
        if (!ctx) return;
        if (ctx.state === 'suspended') ctx.resume();

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10, ctx.currentTime + 0.3);
        
        gain.gain.setValueAtTime(0.5, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

        osc.connect(gain);
        gain.connect(masterGain);
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
    }

    return { init, shoot, thrust, explode, startMusic, stopMusic, toggleMusic, checkResume };
})();

// --- Game Constants & State ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const scoreEl = document.getElementById('score-display');
const livesEl = document.getElementById('lives-display');
const finalScoreEl = document.getElementById('final-score');
const mobileControls = document.getElementById('mobile-controls');

// Settings Elements
const settingsBtn = document.getElementById('settings-btn');
const settingsModal = document.getElementById('settings-modal');
const musicToggle = document.getElementById('music-toggle');
const touchToggle = document.getElementById('touch-toggle');

// Game Config
const FPS = 60;
const FRICTION = 0.7;
const SHIP_SIZE = 20;
const SHIP_THRUST = 5;
const TURN_SPEED = 360;
const BULLET_SPEED = 400;
const ROIDS_NUM = 3;
const ROIDS_SIZE = 80;
const ROIDS_SPD = 50;

// Game State
let ship;
let roids = [];
let bullets = [];
let particles = [];
let score = 0;
let lives = 3;
let level = 0;
let gameRunning = false;

// Input State
const keys = {
    ArrowUp: false,
    ArrowLeft: false,
    ArrowRight: false,
    Space: false
};

// --- Resizing ---
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// --- Input Handling ---
document.addEventListener('keydown', (e) => {
    AudioSys.checkResume(); // Try to resume audio on key press
    if(e.code === 'Space') keys.Space = true;
    if(e.code === 'ArrowUp' || e.code === 'KeyW') keys.ArrowUp = true;
    if(e.code === 'ArrowLeft' || e.code === 'KeyA') keys.ArrowLeft = true;
    if(e.code === 'ArrowRight' || e.code === 'KeyD') keys.ArrowRight = true;
});

document.addEventListener('keyup', (e) => {
    if(e.code === 'Space') keys.Space = false;
    if(e.code === 'ArrowUp' || e.code === 'KeyW') keys.ArrowUp = false;
    if(e.code === 'ArrowLeft' || e.code === 'KeyA') keys.ArrowLeft = false;
    if(e.code === 'ArrowRight' || e.code === 'KeyD') keys.ArrowRight = false;
});

// --- UI / Settings Logic ---

// Toggle Settings Modal
settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent game interaction
    settingsModal.classList.toggle('show');
});

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    if (!settingsModal.contains(e.target) && e.target !== settingsBtn) {
        settingsModal.classList.remove('show');
    }
});

// Music Toggle
musicToggle.addEventListener('change', (e) => {
    AudioSys.toggleMusic(!e.target.checked); // Checked = Music ON, so mute = false
});

// Touch Controls Toggle
touchToggle.addEventListener('change', (e) => {
    if(e.target.checked) {
        mobileControls.classList.remove('hidden');
    } else {
        mobileControls.classList.add('hidden');
    }
});

function setupUiButton(id, keyProp) {
    const btn = document.getElementById(id);
    const setKey = (state) => {
        keys[keyProp] = state;
        if(state) {
            btn.classList.add('active');
            AudioSys.checkResume(); // Try to resume audio on touch
        }
        else btn.classList.remove('active');
    };
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); setKey(true); });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); setKey(false); });
    btn.addEventListener('mousedown', (e) => { setKey(true); });
    btn.addEventListener('mouseup', (e) => { setKey(false); });
    btn.addEventListener('mouseleave', (e) => { setKey(false); });
}

setupUiButton('btn-left', 'ArrowLeft');
setupUiButton('btn-right', 'ArrowRight');
setupUiButton('btn-thrust', 'ArrowUp');
setupUiButton('btn-shoot', 'Space');

// --- Classes ---

class Ship {
    constructor() {
        this.x = canvas.width / 2;
        this.y = canvas.height / 2;
        this.a = 90 / 180 * Math.PI;
        this.r = SHIP_SIZE;
        this.canShoot = true;
        this.rot = 0;
        this.thrusting = false;
        this.thrust = { x: 0, y: 0 };
        this.dead = false;
    }

    update() {
        if (this.dead) return;

        if (keys.ArrowLeft) this.rot = TURN_SPEED / 180 * Math.PI / FPS;
        else if (keys.ArrowRight) this.rot = -TURN_SPEED / 180 * Math.PI / FPS;
        else this.rot = 0;
        this.a += this.rot;

        if (keys.ArrowUp) {
            this.thrusting = true;
            this.thrust.x += SHIP_THRUST * Math.cos(this.a) / FPS;
            this.thrust.y -= SHIP_THRUST * Math.sin(this.a) / FPS;
            // AudioSys.thrust(); // Removed booster sound
        } else {
            this.thrusting = false;
            this.thrust.x -= FRICTION * this.thrust.x / FPS;
            this.thrust.y -= FRICTION * this.thrust.y / FPS;
        }

        this.x += this.thrust.x;
        this.y += this.thrust.y;

        if (this.x < 0 - this.r) this.x = canvas.width + this.r;
        else if (this.x > canvas.width + this.r) this.x = 0 - this.r;
        if (this.y < 0 - this.r) this.y = canvas.height + this.r;
        else if (this.y > canvas.height + this.r) this.y = 0 - this.r;

        if (keys.Space && this.canShoot) {
            this.shoot();
        }
        if (!keys.Space) this.canShoot = true;
    }

    shoot() {
        if (bullets.length < 10) {
            bullets.push(new Bullet(this.x + 4/3 * this.r * Math.cos(this.a), this.y - 4/3 * this.r * Math.sin(this.a), this.a));
            this.canShoot = false;
            AudioSys.shoot();
        }
    }

    draw() {
        if (this.dead) return;
        ctx.strokeStyle = '#39ff14';
        ctx.lineWidth = 2;

        ctx.beginPath();
        ctx.moveTo( 
            this.x + 4/3 * this.r * Math.cos(this.a),
            this.y - 4/3 * this.r * Math.sin(this.a)
        );
        ctx.lineTo( 
            this.x - this.r * (2/3 * Math.cos(this.a) + Math.sin(this.a)),
            this.y + this.r * (2/3 * Math.sin(this.a) - Math.cos(this.a))
        );
        ctx.lineTo( 
            this.x - this.r * (2/3 * Math.cos(this.a) - Math.sin(this.a)),
            this.y + this.r * (2/3 * Math.sin(this.a) + Math.cos(this.a))
        );
        ctx.closePath();
        ctx.stroke();

        if (this.thrusting) {
            ctx.fillStyle = '#ff9900';
            ctx.strokeStyle = '#ffff00';
            ctx.beginPath();
             ctx.moveTo( 
                this.x - this.r * (2/3 * Math.cos(this.a) + 0.5 * Math.sin(this.a)),
                this.y + this.r * (2/3 * Math.sin(this.a) - 0.5 * Math.cos(this.a))
            );
            ctx.lineTo( 
                this.x - this.r * 5/3 * Math.cos(this.a),
                this.y + this.r * 5/3 * Math.sin(this.a)
            );
             ctx.lineTo( 
                this.x - this.r * (2/3 * Math.cos(this.a) - 0.5 * Math.sin(this.a)),
                this.y + this.r * (2/3 * Math.sin(this.a) + 0.5 * Math.cos(this.a))
            );
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
    }
}

class Bullet {
    constructor(x, y, a) {
        this.x = x;
        this.y = y;
        this.xv = BULLET_SPEED * Math.cos(a) / FPS;
        this.yv = -BULLET_SPEED * Math.sin(a) / FPS;
        this.dist = 0;
        this.maxDist = canvas.width * 0.8;
        this.remove = false;
    }

    update() {
        this.x += this.xv;
        this.y += this.yv;

        if (this.x < 0) this.x = canvas.width;
        else if (this.x > canvas.width) this.x = 0;
        if (this.y < 0) this.y = canvas.height;
        else if (this.y > canvas.height) this.y = 0;

        this.dist += Math.sqrt(this.xv**2 + this.yv**2);
        if (this.dist > this.maxDist) this.remove = true;
    }

    draw() {
        ctx.fillStyle = '#fff';
        ctx.fillRect(this.x - 2, this.y - 2, 4, 4);
    }
}

class Asteroid {
    constructor(x, y, r) {
        this.x = x;
        this.y = y;
        this.r = r || Math.ceil(ROIDS_SIZE / 2);
        this.a = Math.random() * Math.PI * 2;
        this.xv = Math.random() * ROIDS_SPD * (Math.random() < 0.5 ? 1 : -1) / FPS;
        this.yv = Math.random() * ROIDS_SPD * (Math.random() < 0.5 ? 1 : -1) / FPS;
        if (r < ROIDS_SIZE/2) {
             this.xv *= 1.5;
             this.yv *= 1.5;
        }
    }

    update() {
        this.x += this.xv;
        this.y += this.yv;

        if (this.x < 0 - this.r) this.x = canvas.width + this.r;
        else if (this.x > canvas.width + this.r) this.x = 0 - this.r;
        if (this.y < 0 - this.r) this.y = canvas.height + this.r;
        else if (this.y > canvas.height + this.r) this.y = 0 - this.r;
    }

    draw() {
        ctx.strokeStyle = '#39ff14';
        ctx.lineWidth = 2;
        const size = this.r * 2;
        ctx.strokeRect(this.x - this.r, this.y - this.r, size, size);
        ctx.lineWidth = 1;
        ctx.strokeRect(this.x - this.r/2, this.y - this.r/2, this.r, this.r);
    }
}

class Particle {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.xv = (Math.random() - 0.5) * (Math.random() * 6);
        this.yv = (Math.random() - 0.5) * (Math.random() * 6);
        this.life = 1.0;
        this.decay = Math.random() * 0.03 + 0.01;
    }
    update() {
        this.x += this.xv;
        this.y += this.yv;
        this.life -= this.decay;
    }
    draw() {
        ctx.fillStyle = `rgba(255, 255, 255, ${this.life})`;
        ctx.fillRect(this.x, this.y, 3, 3);
    }
}

// --- Game Logic ---

function createAsteroidBelt() {
    roids = [];
    for (let i = 0; i < ROIDS_NUM + level; i++) {
        let x, y;
        do {
            x = Math.floor(Math.random() * canvas.width);
            y = Math.floor(Math.random() * canvas.height);
        } while (distBetweenPoints(ship.x, ship.y, x, y) < ROIDS_SIZE * 2 + ship.r);
        roids.push(new Asteroid(x, y));
    }
}

function distBetweenPoints(x1, y1, x2, y2) {
    return Math.sqrt((x2 - x1)**2 + (y2 - y1)**2);
}

function explodeShip() {
    ship.dead = true;
    AudioSys.explode();
    for(let i=0; i<30; i++) {
        particles.push(new Particle(ship.x, ship.y));
    }
    lives--;
    livesEl.innerText = "LIVES: " + lives;
    
    if (lives > 0) {
        setTimeout(() => {
            ship = new Ship();
        }, 2000);
    } else {
        setTimeout(gameOver, 2000);
    }
}

function destroyAsteroid(index) {
    const x = roids[index].x;
    const y = roids[index].y;
    const r = roids[index].r;

    if (r >= ROIDS_SIZE / 2) { 
        roids.push(new Asteroid(x, y, r / 2));
        roids.push(new Asteroid(x, y, r / 2));
        score += 20;
    } else if (r >= ROIDS_SIZE / 4) { 
        roids.push(new Asteroid(x, y, r / 2));
        roids.push(new Asteroid(x, y, r / 2));
        score += 50;
    } else {
        score += 100;
    }
    
    for(let i=0; i<10; i++) particles.push(new Particle(x, y));
    
    roids.splice(index, 1);
    AudioSys.explode();
    scoreEl.innerText = "SCORE: " + score;

    if (roids.length === 0) {
        level++;
        createAsteroidBelt();
    }
}

function update() {
    ship.update();

    for (let i = bullets.length - 1; i >= 0; i--) {
        bullets[i].update();
        if (bullets[i].remove) {
            bullets.splice(i, 1);
            continue;
        }

        for (let j = roids.length - 1; j >= 0; j--) {
            let ax = roids[j].x;
            let ay = roids[j].y;
            let ar = roids[j].r;
            let bx = bullets[i].x;
            let by = bullets[i].y;

            if (bx > ax - ar && bx < ax + ar && by > ay - ar && by < ay + ar) {
                bullets.splice(i, 1);
                destroyAsteroid(j);
                break;
            }
        }
    }

    for (let i = 0; i < roids.length; i++) {
        roids[i].update();
        
        if (!ship.dead) {
            let ax = roids[i].x;
            let ay = roids[i].y;
            let ar = roids[i].r;
            let sx = ship.x;
            let sy = ship.y;
            
            if (sx > ax - ar*0.8 && sx < ax + ar*0.8 && sy > ay - ar*0.8 && sy < ay + ar*0.8) {
                explodeShip();
            }
        }
    }

    for(let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        if(particles[i].life <= 0) particles.splice(i, 1);
    }
}

function draw() {
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ship.draw();
    for (let b of bullets) b.draw();
    for (let r of roids) r.draw();
    for (let p of particles) p.draw();
}

function loop(timestamp) {
    if (!gameRunning) return;
    lastTime = timestamp;
    update();
    draw();
    requestAnimationFrame(loop);
}

function startGame() {
    AudioSys.init();
    AudioSys.startMusic();
    startScreen.classList.add('hidden');
    gameOverScreen.classList.add('hidden');
    gameRunning = true;
    score = 0;
    lives = 3;
    level = 0;
    ship = new Ship();
    bullets = [];
    particles = [];
    scoreEl.innerText = "SCORE: 0";
    livesEl.innerText = "LIVES: 3";
    createAsteroidBelt();
    requestAnimationFrame(loop);
}

function gameOver() {
    gameRunning = false;
    AudioSys.stopMusic();
    finalScoreEl.innerText = "SCORE: " + score;
    gameOverScreen.classList.remove('hidden');
}

// Event Listeners
document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('restart-btn').addEventListener('click', startGame);

</script>
</body>
</html>